<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AFL 2026 Ladder Prediction</title>
  <style>
    :root { --border:#ddd; --bg:#f6f6f6; --active:#eef6ff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
    header { display:flex; justify-content:space-between; gap:12px; align-items:baseline; flex-wrap:wrap; }
    h1 { margin:0; font-size: 24px; }
    h2 { margin: 20px 0 10px; }
    .muted { opacity: .7; }
    button { padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: white; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .card { border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--bg); }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; }
    th.right, td.right { text-align: right; }
    tr.clickable { cursor:pointer; }
    tr.active { background: var(--active); }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 12px; }
    .tab { padding: 8px 10px; border-radius: 999px; border:1px solid var(--border); background: white; cursor:pointer; }
    .tab.active { background: #111; color: white; border-color: #111; }
    .error { margin-top: 16px; padding: 12px; background: #ffe9e9; border: 1px solid #ffb3b3; border-radius: 10px; }
    footer { margin-top: 26px; opacity: .65; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>AFL 2026 Ladder Prediction</h1>
        <div class="muted" id="updatedAt">Last updated: —</div>
      </div>
      <button id="refreshBtn">Refresh</button>
    </header>

    <div id="errorBox" class="error" style="display:none;"></div>

    <section>
      <h2>Leaderboard</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th class="right">Total Points</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr><td colspan="3">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px;">Click a player to view breakdown.</div>
    </section>

    <section>
      <h2>Player Breakdown</h2>
      <div class="tabs" id="tabs"></div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th class="right">Predicted</th>
              <th class="right">Actual</th>
              <th class="right">Diff</th>
              <th class="right">Points</th>
            </tr>
          </thead>
          <tbody id="breakdownBody">
            <tr><td colspan="5">Select a player.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer>Backend: Google Apps Script · Data: Google Sheets</footer>
  </div>

  <script>
    // ✅ PASTE YOUR APPS SCRIPT WEB APP URL HERE:
    const API_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE";

    const elUpdatedAt = document.getElementById("updatedAt");
    const elErrorBox = document.getElementById("errorBox");
    const elRefreshBtn = document.getElementById("refreshBtn");
    const elLeaderboardBody = document.getElementById("leaderboardBody");
    const elTabs = document.getElementById("tabs");
    const elBreakdownBody = document.getElementById("breakdownBody");

    let state = {
      data: null,
      activePlayer: null
    };

    function fmtIso(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }

    function showError(msg) {
      elErrorBox.style.display = "block";
      elErrorBox.innerHTML = "<b>Error:</b> " + msg +
        "<div style='margin-top:8px;opacity:.8'>Tip: Make sure your Apps Script deployment allows public access and CORS isn’t blocked.</div>";
    }

    function clearError() {
      elErrorBox.style.display = "none";
      elErrorBox.textContent = "";
    }

    function render() {
      const data = state.data;
      const players = data?.leaderboard || [];

      elUpdatedAt.textContent = "Last updated: " + (data?.updatedAt ? fmtIso(data.updatedAt) : "—");

      // Leaderboard
      if (!players.length) {
        elLeaderboardBody.innerHTML = "<tr><td colspan='3'>No data yet.</td></tr>";
      } else {
        elLeaderboardBody.innerHTML = players.map((p, idx) => {
          const active = p.name === state.activePlayer ? "active" : "";
          return `
            <tr class="clickable ${active}" data-player="${p.name}">
              <td>${idx + 1}</td>
              <td><b>${p.name}</b></td>
              <td class="right">${p.total}</td>
            </tr>
          `;
        }).join("");
      }

      // Tabs
      elTabs.innerHTML = players.map(p => {
        const active = p.name === state.activePlayer ? "active" : "";
        return `<button class="tab ${active}" data-player="${p.name}">${p.name}</button>`;
      }).join("");

      // Breakdown
      const activePlayerObj = players.find(p => p.name === state.activePlayer) || players[0] || null;
      if (activePlayerObj && !state.activePlayer) state.activePlayer = activePlayerObj.name;

      if (!activePlayerObj) {
        elBreakdownBody.innerHTML = "<tr><td colspan='5'>Select a player.</td></tr>";
      } else {
        elBreakdownBody.innerHTML = activePlayerObj.breakdown.map(r => `
          <tr>
            <td>${r.team}</td>
            <td class="right">${r.predictedRank ?? "—"}</td>
            <td class="right">${r.actualRank ?? "—"}</td>
            <td class="right">${r.diff ?? "—"}</td>
            <td class="right"><b>${r.points}</b></td>
          </tr>
        `).join("");
      }
    }

    async function load() {
      clearError();
      elRefreshBtn.disabled = true;
      elRefreshBtn.textContent = "Refreshing…";

      try {
        if (!API_URL || API_URL.includes("PASTE_")) {
          throw new Error("You haven’t set API_URL in the HTML yet.");
        }
        const res = await fetch(API_URL, { cache: "no-store" });
        const json = await res.json();
        if (json.error) throw new Error(json.error);

        state.data = json;
        if (!state.activePlayer && json.leaderboard?.length) {
          state.activePlayer = json.leaderboard[0].name;
        }
        render();
      } catch (e) {
        showError(String(e));
        elLeaderboardBody.innerHTML = "<tr><td colspan='3'>Failed to load.</td></tr>";
      } finally {
        elRefreshBtn.disabled = false;
        elRefreshBtn.textContent = "Refresh";
      }
    }

    // Click handlers (event delegation)
    document.addEventListener("click", (e) => {
      const row = e.target.closest("[data-player]");
      if (row) {
        state.activePlayer = row.getAttribute("data-player");
        render();
      }
    });

    elRefreshBtn.addEventListener("click", load);

    // Load now + auto refresh every 60s
    load();
    setInterval(load, 60000);
  </script>
</body>
</html>

